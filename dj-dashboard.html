<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DJ Dashboard - Externally Yours Productions, LLC">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data:; font-src 'self' data:; connect-src 'self';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <title>DJ Dashboard - Externally Yours Productions, LLC</title>
    <link rel="icon" type="image/png" href="EYP Logo_New.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #ffffff;
            --accent-color: #ff6b35;
            --text-dark: #333;
            --text-light: #666;
            --bg-light: #f8f8f8;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--bg-light);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Main Layout Wrapper */
        .dashboard-wrapper {
            display: flex;
            flex: 1;
            min-height: 0;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 260px;
            background: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
        }

        .sidebar-overlay.show {
            display: block;
        }

        .mobile-menu-btn {
            display: none;
            background: transparent;
            border: none;
            color: var(--secondary-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: 1rem;
        }

        .mobile-menu-btn:hover {
            opacity: 0.8;
        }

        .sidebar-logo-container {
            padding: 1.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo-container a {
            display: inline-block;
            cursor: pointer;
            text-decoration: none;
        }

        .sidebar-logo {
            height: 60px;
            width: auto;
            max-width: 100%;
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 0;
            flex: 1;
            padding-top: 2rem;
        }

        .sidebar-nav-item {
            margin: 0;
        }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            cursor: pointer;
        }

        .sidebar-nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .sidebar-nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            border-left-color: white;
            color: white;
            font-weight: 500;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            background: var(--bg-light);
        }

        /* Header */
        .dashboard-header {
            background: var(--primary-color);
            color: var(--secondary-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header h1 {
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dashboard-header img {
            height: 50px;
            width: auto;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
            position: relative;
        }

        .user-profile-menu {
            position: relative;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--secondary-color);
        }

        .profile-icon:hover {
            border-color: var(--secondary-color);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .profile-icon img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .profile-dropdown {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: var(--secondary-color);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            min-width: 350px;
            max-width: 400px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 0.5rem 0;
            z-index: 1000;
            display: none;
            animation: slideDown 0.2s ease;
        }

        .profile-dropdown.show {
            display: block;
        }

        .profile-dropdown-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .profile-dropdown-name {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .profile-dropdown-email {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .profile-dropdown-menu {
            list-style: none;
            padding: 0.5rem 0;
        }

        .profile-dropdown-menu li {
            padding: 0;
        }

        .profile-dropdown-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: var(--text-dark);
            text-decoration: none;
            transition: background 0.2s ease;
            font-size: 0.95rem;
        }

        .profile-dropdown-menu a:hover {
            background: var(--bg-light);
        }

        .profile-dropdown-menu .divider {
            height: 1px;
            background: #e0e0e0;
            margin: 0.5rem 0;
        }

        .profile-dropdown-account {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            display: none;
        }

        .profile-dropdown-account.show {
            display: block;
        }

        .profile-dropdown-account h3 {
            font-size: 1rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .profile-dropdown-form {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .profile-dropdown-form .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .profile-dropdown-form label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-dark);
        }

        .profile-dropdown-form input {
            padding: 0.5rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .profile-dropdown-form input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .profile-dropdown-form input:disabled {
            background: var(--bg-light);
            cursor: not-allowed;
        }

        .profile-dropdown-form-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .profile-dropdown-form .btn {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        .profile-dropdown-success {
            padding: 0.75rem;
            background: #d4edda;
            color: #155724;
            border-radius: 5px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
            display: none;
        }

        .profile-dropdown-success.show {
            display: block;
        }

        .logout-btn {
            padding: 0.5rem 1rem;
            background: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s ease;
        }

        .logout-btn:hover {
            background: #e55a2b;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Main Container */
        .dashboard-container {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: 1600px;
            width: 100%;
            margin: 0 auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Dashboard Layout */
        .dashboard-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 1024px) {
            .dashboard-layout {
                grid-template-columns: 1fr;
            }
        }

        /* Tabs - Only for bookings filter now */
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 1rem 2rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: var(--accent-color);
            border-bottom-color: var(--accent-color);
        }

        .tab-button:hover {
            color: var(--primary-color);
        }

        /* Section Containers */
        .section-container {
            display: none;
        }

        .section-container.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
            border-color: #e0e0e0;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-card-header h3 {
            font-size: 0.95rem;
            color: var(--text-light);
            font-weight: 500;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            line-height: 1;
        }

        /* Calendar Section */
        .calendar-section {
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        /* Calendar Widgets Container */
        .calendars-container {
            display: flex;
            justify-content: center;                                            
            margin-bottom: 2rem;
        }

        /* Visual Calendar Widget */
        .calendar-widget {
            background: var(--bg-light);
            border-radius: 16.12px;
            padding: 1.21rem;
            max-width: 645px;
            margin-bottom: 2rem;
        }

        .calendar-widget-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .calendar-widget-header h3 {
            color: var(--primary-color);
            font-size: 1.24rem;
        }

        .calendar-nav-btn {
            background: var(--accent-color);
            color: var(--secondary-color);
            border: none;
            border-radius: 6.88px;
            padding: 0.34rem 0.69rem;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.03rem;
            transition: background 0.3s ease;
        }

        .calendar-nav-btn:hover {
            background: #e55a2b;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.34rem;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            color: var(--text-light);
            padding: 0.34rem;
            font-size: 0.89rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--secondary-color);
            position: relative;
        }

        .calendar-day:hover {
            background: var(--bg-light);
        }

        .calendar-day.other-month {
            opacity: 0.3;
        }

        .calendar-day.today {
            background: var(--accent-color);
            color: var(--secondary-color);
            font-weight: bold;
        }

        .calendar-day.blocked {
            background: var(--primary-color);
            color: var(--secondary-color);
            font-weight: bold;
        }

        .calendar-day.has-booking {
            background: #d4edda;
            color: var(--primary-color);
            font-weight: bold;
            border: 2px solid var(--success-color);
        }

        .calendar-day-number {
            font-size: 0.89rem;
        }

        .calendar-day-indicator {
            width: 5.5px;
            height: 5.5px;
            border-radius: 50%;
            margin-top: 1.38px;
        }

        .calendar-day.blocked .calendar-day-indicator {
            background: var(--secondary-color);
        }

        .calendar-day.has-booking .calendar-day-indicator {
            background: var(--secondary-color);
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .calendar-header h2 {
            color: var(--primary-color);
        }

        .block-date-form {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .form-input {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent-color);
            color: var(--secondary-color);
        }

        .btn-primary:hover {
            background: #e55a2b;
        }

        .btn-danger {
            background: #dc3545;
            color: var(--secondary-color);
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: var(--text-light);
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background: #555;
        }

        /* Blocked Dates List */
        .blocked-dates-list {
            margin-top: 2rem;
        }

        .blocked-date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--bg-light);
            border-radius: 5px;
            margin-bottom: 0.5rem;
        }

        .blocked-date-item .btn {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .blocked-date-info {
            display: flex;
            flex-direction: row;
            gap: 1rem;
            align-items: center;
            flex: 1;
        }

        .blocked-date-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .date-badge {
            padding: 0.25rem 0.75rem;
            background: var(--primary-color);
            color: var(--secondary-color);
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }

        /* Projects Section */
        .bookings-section {
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .bookings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .bookings-header h2 {
            color: var(--primary-color);
        }

        .bookings-filter {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-light);
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: var(--accent-color);
            color: var(--secondary-color);
            border-color: var(--accent-color);
        }

        .bookings-list {
            display: grid;
            gap: 1rem;
        }

        .booking-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.5rem;
            transition: all 0.3s ease;
        }

        .booking-card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .booking-card.upcoming {
            border-left: 4px solid var(--success-color);
        }

        .booking-card.past {
            border-left: 4px solid var(--text-light);
            opacity: 0.7;
        }

        .booking-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .booking-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .booking-date {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .booking-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .booking-detail-item {
            display: flex;
            flex-direction: column;
        }

        .booking-detail-label {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-bottom: 0.25rem;
        }

        .booking-detail-value {
            font-weight: 500;
            color: var(--text-dark);
        }

        .reminder-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--info-color);
            color: var(--secondary-color);
            border-radius: 20px;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        /* Reviews Section */
        .reviews-section {
            background: var(--secondary-color);
            border-radius: 10px;
            padding: 2rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-top: 2rem;
        }

        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .reviews-header h2 {
            color: var(--primary-color);
        }

        .reviews-stats {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .rating-display {
            text-align: center;
        }

        .rating-number {
            font-size: 3rem;
            font-weight: bold;
            color: var(--accent-color);
            line-height: 1;
        }

        .rating-stars {
            font-size: 1.2rem;
            color: var(--warning-color);
            margin-top: 0.5rem;
        }

        .total-reviews {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        .reviews-list {
            display: grid;
            gap: 1.5rem;
        }

        .review-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 1.5rem;
            background: var(--bg-light);
            transition: box-shadow 0.3s ease;
        }

        .review-card:hover {
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .review-client {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .review-event {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .review-date {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .review-rating {
            color: var(--warning-color);
            font-size: 1.1rem;
            margin: 0.5rem 0;
        }

        .review-text {
            color: var(--text-dark);
            line-height: 1.6;
            margin-top: 0.75rem;
        }

        .no-reviews {
            text-align: center;
            padding: 3rem;
            color: var(--text-light);
        }

        .no-reviews-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 0.75rem;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-group input:disabled {
            background: var(--bg-light);
            cursor: not-allowed;
        }

        .form-actions {
            grid-column: 1 / -1;
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .btn-success {
            background: var(--success-color);
            color: var(--secondary-color);
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-secondary {
            background: var(--text-light);
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background: #555;
        }

        .save-success {
            grid-column: 1 / -1;
            padding: 1rem;
            background: #d4edda;
            color: #155724;
            border-radius: 5px;
            margin-top: 1rem;
            display: none;
        }

        .save-success.show {
            display: block;
        }

        /* Security Session Warning */
        .session-warning {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--warning-color);
            color: var(--primary-color);
            padding: 1rem;
            text-align: center;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            font-weight: bold;
        }

        .session-warning.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .session-warning-button {
            margin-left: 1rem;
            padding: 0.5rem 1rem;
            background: var(--primary-color);
            color: var(--secondary-color);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .session-warning-button:hover {
            background: var(--accent-color);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
                font-size: 1.2rem;
            }

            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
                z-index: 100;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.show {
                display: block;
            }

            .dashboard-container {
                padding: 0.75rem;
            }

            .block-date-form {
                flex-direction: column;
            }

            .dashboard-header {
                flex-direction: row;
                padding: 0.75rem;
            }

            .dashboard-header h1 {
                font-size: 1.1rem;
            }

            #header-welcome,
            #header-user-name {
                font-size: 1.1rem !important;
            }

            /* Stat Cards - Smaller on Mobile */
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }

            .stat-card {
                padding: 1rem;
                border-radius: 8px;
            }

            .stat-card-header {
                margin-bottom: 0.75rem;
            }

            .stat-card-header h3 {
                font-size: 0.8rem;
            }

            .stat-icon {
                font-size: 1rem;
            }

            .stat-value {
                font-size: 1.5rem;
            }

            /* Next Booking stat has inline style - override it */
            #next-booking-stat {
                font-size: 1rem !important;
            }

            /* Section containers - reduce padding on mobile */
            .section-container {
                padding: 1rem;
            }

            .calendar-section {
                padding: 1rem !important;
            }

            /* Calendar widget - smaller on mobile */
            .calendar-widget {
                padding: 0.75rem;
                max-width: 100%;
            }

            .calendar-widget-header h3 {
                font-size: 1rem;
            }

            .calendar-nav-btn {
                padding: 0.25rem 0.5rem;
                font-size: 0.9rem;
            }

            /* Reviews section - smaller fonts */
            .reviews-section {
                padding: 1rem;
            }

            .reviews-header h2 {
                font-size: 1.25rem;
            }

            .rating-number {
                font-size: 2rem;
            }

            .review-card {
                padding: 1rem;
            }

            .review-client {
                font-size: 0.95rem;
            }

            .review-text {
                font-size: 0.9rem;
            }

            /* Projects section */
            .projects-section {
                padding: 1rem;
            }

            .bookings-filter {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .filter-btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            .tabs {
                overflow-x: auto;
            }

            /* General font size reductions */
            body {
                font-size: 0.9rem;
            }

            h2 {
                font-size: 1.25rem;
            }

            h3 {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Session Timeout Warning -->
    <div class="session-warning" id="session-warning">
        <span>Your session will expire soon due to inactivity.</span>
        <button class="session-warning-button" onclick="extendSession()">Stay Logged In</button>
    </div>

    <div class="dashboard-wrapper">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-logo-container">
                <a href="#" onclick="showSection('dashboard'); return false;">
                    <img src="EYP Logo_New.png" alt="EYP Logo" class="sidebar-logo">
                </a>
            </div>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item">
                    <a class="sidebar-nav-link active" onclick="showSection('dashboard')" id="nav-dashboard">
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a class="sidebar-nav-link" onclick="showSection('projects')" id="nav-projects">
                        <span>Projects</span>
                    </a>
                </li>
                <li class="sidebar-nav-item">
                    <a class="sidebar-nav-link" onclick="showSection('reviews')" id="nav-reviews">
                        <span>Reviews</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

        <!-- Main Content Area -->
        <div class="main-content">
        <div class="dashboard-header">
        <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Toggle menu">
            ‚ò∞
        </button>
        <h1 style="margin: 0;">
            <span id="header-welcome" style="font-size: 1.5rem; font-weight: 500;">Welcome, </span>
            <span id="header-user-name" style="font-size: 1.5rem; font-weight: 500;">DJ User</span>
        </h1>
        <div class="header-actions">
            <div class="user-profile-menu">
                <div class="profile-icon" id="profile-icon" onclick="toggleProfileDropdown()">
                    <span id="profile-initials">DJ</span>
                </div>
                <div class="profile-dropdown" id="profile-dropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-name" id="dropdown-name">DJ User</div>
                    </div>
                    <ul class="profile-dropdown-menu">
                        <li><a href="#" onclick="toggleAccountSettings(); return false;">Account Settings</a></li>
                    </ul>
                    <div class="profile-dropdown-account" id="profile-account-form">
                        <h3>Account Information</h3>
                        <form id="dropdown-account-form" class="profile-dropdown-form" onsubmit="saveAccountFromDropdown(event); return false;">
                            <div class="form-group" style="text-align: center; margin-bottom: 1rem;">
                                <label for="profile-picture-upload" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Profile Picture</label>
                                <div id="profile-picture-preview" style="display: inline-block; width: 80px; height: 80px; border-radius: 50%; background: var(--accent-color); margin-bottom: 0.5rem; overflow: hidden; border: 2px solid #e0e0e0;">
                                    <img id="profile-picture-img" src="" alt="Profile" style="width: 100%; height: 100%; object-fit: cover; display: none;">
                                    <span id="profile-picture-initials" style="display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; color: white; font-weight: bold; font-size: 1.5rem;"></span>
                                </div>
                                <input type="file" id="profile-picture-upload" accept="image/*" style="display: none;" onchange="handleProfilePictureUpload(event)">
                                <button type="button" onclick="document.getElementById('profile-picture-upload').click();" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.85rem;">Change Picture</button>
                            </div>
                            <div class="form-group">
                                <label for="dropdown-username">Username</label>
                                <input type="text" id="dropdown-username" placeholder="Enter your username" required>
                            </div>
                            <div class="form-group">
                                <label for="dropdown-name">Full Name</label>
                                <input type="text" id="dropdown-name" placeholder="Enter your full name">
                            </div>
                            <div class="form-group">
                                <label for="dropdown-email">Email Address *</label>
                                <input type="email" id="dropdown-email" required>
                            </div>
                            <div class="form-group">
                                <label for="dropdown-phone">Phone Number</label>
                                <input type="tel" id="dropdown-phone" placeholder="(555) 555-5555">
                            </div>
                            <div class="profile-dropdown-success" id="dropdown-save-success">
                                Your account information has been updated successfully!
                            </div>
                            <div class="profile-dropdown-form-actions">
                                <button type="submit" class="btn btn-success">Save</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelAccountFromDropdown()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="profile-dropdown-footer" style="border-top: 1px solid #e0e0e0; padding-top: 0.75rem; margin-top: 0.75rem;">
                        <a href="#" onclick="logout(); return false;" style="display: block; padding: 0.75rem 1rem; color: var(--text-dark); text-decoration: none; transition: background 0.2s ease; font-size: 0.95rem; text-align: center;">Logout</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

            <div class="dashboard-container">
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-container active">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Welcome Back!</h2>
                <p style="color: var(--text-light);">View your upcoming projects, calendar, and reviews using the navigation menu.</p>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card" onclick="goToNextBooking()" style="cursor: pointer;">
                    <div class="stat-card-header">
                        <h3>
                            <span class="stat-icon">üìÜ</span>
                            Next Booking
                        </h3>
                    </div>
                    <div class="stat-value" id="next-booking-stat" style="font-size: 1.25rem;">No upcoming bookings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <h3>
                            <span class="stat-icon">üìÖ</span>
                            Total Bookings
                        </h3>
                    </div>
                    <div class="stat-value" id="total-bookings-stat">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-header">
                        <h3>
                            <span class="stat-icon">üí∞</span>
                            Total Revenue
                        </h3>
                    </div>
                    <div class="stat-value" id="total-revenue-stat">$0.00</div>
                </div>
            </div>

            <!-- Calendar Widget -->
            <div class="calendar-section" style="margin-top: 2rem;">
                <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Calendar & Schedule</h2>
                
                <div class="calendars-container" style="display: flex; justify-content: center;">
                <div class="calendar-widget">
                    <div class="calendar-widget-header">
                        <button class="calendar-nav-btn" onclick="previousMonth()">‚Üê Prev</button>
                        <h3 id="calendar-month-year">January 2025</h3>
                        <button class="calendar-nav-btn" onclick="nextMonth()">Next ‚Üí</button>
                    </div>
                    <div id="calendar-grid-container">
                        <!-- Calendar grid will be generated here -->
                    </div>
                </div>
                </div>

                <!-- Blocked Dates List -->
                <div class="blocked-dates-list" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Blocked Dates</h3>
                    <div id="blocked-dates-container">
                        <!-- Blocked dates will be populated here -->
                    </div>
                </div>

                <!-- Booking Details Modal -->
                <div id="booking-details-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 10px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                        <button onclick="closeBookingDetails()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                        <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Booking Details</h2>
                        <div id="booking-details-content">
                            <!-- Booking details will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Block Date Confirmation Modal -->
                <div id="block-date-confirm-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 10px; padding: 2rem; max-width: 500px; width: 90%; position: relative; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);">
                        <button onclick="closeBlockDateConfirmModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                        <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Block Date</h2>
                        <div id="block-date-confirm-content">
                            <!-- Modal content will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Blocked Date Edit Modal -->
                <div id="blocked-date-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 10px; padding: 2rem; max-width: 500px; width: 90%; position: relative;">
                        <button onclick="closeBlockedDateModal()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                        <h2 style="color: var(--primary-color); margin-bottom: 1rem;" id="blocked-date-modal-title">Edit Blocked Date</h2>
                        <div id="blocked-date-modal-content">
                            <!-- Modal content will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendar-section" class="section-container calendar-section">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Calendar & Schedule</h2>
                <p style="color: var(--text-light);">View your bookings and manage blocked dates.</p>
            </div>

            <!-- Calendar Widget (15% smaller) -->
            <div class="calendars-container" style="display: flex; justify-content: center;">
                <div class="calendar-widget" style="transform: scale(0.85); transform-origin: top center; margin-bottom: -15%;">
                    <div class="calendar-widget-header">
                        <button class="calendar-nav-btn" onclick="previousMonthCalendarPage()">‚Üê Prev</button>
                        <h3 id="calendar-month-year-page">January 2025</h3>
                        <button class="calendar-nav-btn" onclick="nextMonthCalendarPage()">Next ‚Üí</button>
                    </div>
                    <div id="calendar-grid-container-page">
                        <!-- Calendar grid will be generated here -->
                    </div>
                </div>
            </div>

            <!-- Blocked Dates List -->
            <div class="blocked-dates-list" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Blocked Dates</h3>
                <div id="blocked-dates-container-page">
                    <!-- Blocked dates will be populated here -->
                </div>
            </div>

            <!-- Booking Details Modal for Calendar Page -->
            <div id="booking-details-modal-page" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 10px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="closeBookingDetailsPage()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                    <h2 style="color: var(--primary-color); margin-bottom: 1rem;">Booking Details</h2>
                    <div id="booking-details-content-page">
                        <!-- Booking details will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Blocked Date Edit Modal for Calendar Page -->
            <div id="blocked-date-modal-page" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 10px; padding: 2rem; max-width: 500px; width: 90%; position: relative;">
                    <button onclick="closeBlockedDateModalPage()" style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                    <h2 style="color: var(--primary-color); margin-bottom: 1rem;" id="blocked-date-modal-title-page">Edit Blocked Date</h2>
                    <div id="blocked-date-modal-content-page">
                        <!-- Modal content will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Projects Section -->
        <div id="projects-section" class="section-container bookings-section">
            <div class="bookings-header">
                <h2>Current Projects</h2>
                <div class="bookings-filter">
                    <button class="filter-btn active" onclick="filterBookings('all')">All</button>
                    <button class="filter-btn" onclick="filterBookings('upcoming')">Upcoming</button>
                    <button class="filter-btn" onclick="filterBookings('past')">Past</button>
                </div>
            </div>
            <div id="bookings-container" class="bookings-list">
                <!-- Projects will be populated here -->
            </div>
        </div>

        <!-- Reviews Section -->
        <div id="reviews-section" class="section-container reviews-section">
            <div class="reviews-header">
                <h2>Customer Reviews</h2>
                <div class="reviews-stats" id="reviews-stats">
                    <div class="rating-display">
                        <div class="rating-number" id="average-rating">0.0</div>
                        <div class="rating-stars" id="rating-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
                        <div class="total-reviews" id="total-reviews">0 Reviews</div>
                    </div>
                </div>
            </div>
            <div id="reviews-container" class="reviews-list">
                <!-- Reviews will be populated here -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        // ========================================
        // SECURITY MEASURES
        // ========================================
        
        // Session timeout configuration (30 minutes of inactivity)
        const SESSION_TIMEOUT = 30 * 60 * 1000; // 30 minutes in milliseconds
        const SESSION_WARNING_TIME = 5 * 60 * 1000; // Show warning 5 minutes before timeout
        const TOKEN_EXPIRY_KEY = 'dj_token_expiry';
        let activityTimeout;
        let warningTimeout;
        let lastActivity = Date.now();

        // Input sanitization function to prevent XSS attacks
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Validate and check token expiration
        function validateToken() {
            const token = localStorage.getItem('dj_token');
            const tokenExpiry = localStorage.getItem(TOKEN_EXPIRY_KEY);
            
            if (!token) {
                return false;
            }
            
            // Check if token has expired
            if (tokenExpiry) {
                const expiryTime = parseInt(tokenExpiry, 10);
                if (Date.now() > expiryTime) {
                    // Token expired
                    secureLogout('Your session has expired. Please log in again.');
                    return false;
                }
            }
            
            return true;
        }

        // Update last activity timestamp
        function updateActivity() {
            lastActivity = Date.now();
            localStorage.setItem('dj_last_activity', lastActivity.toString());
            
            // Hide warning if showing
            const warning = document.getElementById('session-warning');
            if (warning) {
                warning.classList.remove('show');
            }
            
            // Reset activity timeout
            if (activityTimeout) {
                clearTimeout(activityTimeout);
            }
            if (warningTimeout) {
                clearTimeout(warningTimeout);
            }
            
            // Set warning timeout (5 minutes before logout)
            warningTimeout = setTimeout(() => {
                if (document.getElementById('session-warning')) {
                    document.getElementById('session-warning').classList.add('show');
                }
            }, SESSION_TIMEOUT - SESSION_WARNING_TIME);
            
            // Set logout timeout
            activityTimeout = setTimeout(() => {
                secureLogout('You have been logged out due to inactivity. Please log in again.');
            }, SESSION_TIMEOUT);
        }

        // Extend session when user clicks "Stay Logged In"
        function extendSession() {
            updateActivity();
            logSecurityEvent('session_extended', {});
        }

        // Track user activity
        const activityEvents = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart', 'click'];
        activityEvents.forEach(event => {
            document.addEventListener(event, updateActivity, { passive: true });
        });

        // Log security events (in production, send to backend)
        function logSecurityEvent(eventType, details) {
            const logEntry = {
                timestamp: new Date().toISOString(),
                event: eventType,
                user: localStorage.getItem('dj_user'),
                details: details,
                userAgent: navigator.userAgent,
                ip: 'N/A' // Would be set by backend
            };
            
            // Store in localStorage (in production, send to backend API)
            const securityLogs = JSON.parse(localStorage.getItem('dj_security_logs') || '[]');
            securityLogs.push(logEntry);
            
            // Keep only last 100 log entries
            if (securityLogs.length > 100) {
                securityLogs.shift();
            }
            
            localStorage.setItem('dj_security_logs', JSON.stringify(securityLogs));
            
            // Log to console for debugging (remove in production)
            console.log('Security Event:', logEntry);
        }

        // Secure logout function
        function secureLogout(message) {
            logSecurityEvent('logout', { reason: message || 'User logout' });
            
            // Clear all authentication data
            localStorage.removeItem('dj_token');
            localStorage.removeItem('dj_user');
            localStorage.removeItem(TOKEN_EXPIRY_KEY);
            localStorage.removeItem('dj_last_activity');
            
            // Clear activity timeout
            if (activityTimeout) {
                clearTimeout(activityTimeout);
            }
            
            // Remove activity event listeners
            activityEvents.forEach(event => {
                document.removeEventListener(event, updateActivity);
            });
            
            // Redirect to login
            if (message) {
                sessionStorage.setItem('logout_message', message);
            }
            window.location.href = 'dj-login.html';
        }

        // Enhanced authentication check with token validation
        if (!validateToken()) {
            window.location.href = 'dj-login.html';
            throw new Error('Authentication failed');
        }

        // ========================================
        // API Helper Functions
        // ========================================
        const API_BASE = ''; // Use relative URLs for same domain
        const CACHE_DURATION = 120000; // 2 minutes (increased for better performance)
        
        // Request deduplication - prevents multiple identical requests
        const inFlightRequests = new Map();
        
        async function apiRequest(endpoint, options = {}) {
            // Create a unique key for this request
            const requestKey = `${endpoint}_${JSON.stringify(options)}`;
            
            // If this request is already in flight, return the existing promise
            if (inFlightRequests.has(requestKey)) {
                return inFlightRequests.get(requestKey);
            }
            
            // Create new request promise
            const requestPromise = (async () => {
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`, {
                        ...options,
                        headers: {
                            'Content-Type': 'application/json',
                            ...options.headers
                        }
                    });
                    
                    if (!response.ok) {
                        const error = await response.json().catch(() => ({ error: response.statusText }));
                        throw new Error(error.error || `HTTP ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('API request failed:', endpoint, error);
                    throw error;
                } finally {
                    // Remove from in-flight requests when done
                    inFlightRequests.delete(requestKey);
                }
            })();
            
            // Store the promise
            inFlightRequests.set(requestKey, requestPromise);
            
            return requestPromise;
        }
        
        // Bookings API
        async function apiGetBookings(djUser = null) {
            const url = djUser ? `/api/bookings?dj_user=${encodeURIComponent(djUser)}` : '/api/bookings';
            const result = await apiRequest(url);
            return result.data || [];
        }
        
        // Blocked Dates API
        async function apiGetBlockedDates(djUser = null) {
            const url = djUser ? `/api/blocked-dates?dj_user=${encodeURIComponent(djUser)}` : '/api/blocked-dates';
            const result = await apiRequest(url);
            return result.data || [];
        }
        
        async function apiCreateBlockedDate(blockedDate) {
            const result = await apiRequest('/api/blocked-dates', {
                method: 'POST',
                body: JSON.stringify(blockedDate)
            });
            return result.data;
        }
        
        async function apiDeleteBlockedDate(id) {
            await apiRequest(`/api/blocked-dates/${id}`, { method: 'DELETE' });
        }
        
        // Reviews API
        async function apiGetReviews(djUsername = null) {
            const url = djUsername ? `/api/reviews?dj_username=${encodeURIComponent(djUsername)}` : '/api/reviews';
            const result = await apiRequest(url);
            return result.data || [];
        }
        
        // Users API (for getting current user info)
        async function apiGetUsers(userType = null) {
            const url = userType ? `/api/users?user_type=${userType}` : '/api/users';
            const result = await apiRequest(url);
            return result.data || [];
        }
        
        // Helper: Get all bookings for current DJ
        let bookingsCache = null;
        let bookingsCacheTime = null;
        
        async function getAllBookingsForDJ() {
            const currentUsername = localStorage.getItem('dj_user');
            if (!currentUsername) return [];
            
            // Use cache if available and recent
            const now = Date.now();
            if (bookingsCache && bookingsCacheTime && (now - bookingsCacheTime) < CACHE_DURATION) {
                return bookingsCache;
            }
            
            try {
                // Get all bookings and filter for this DJ
                const allBookings = await apiGetBookings();
                
                // Get DJ user info to match by firstName/lastName or username
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                if (!currentDJ) {
                    console.warn('Current DJ user not found in database');
                    return [];
                }
                
                // Create possible names to match
                const possibleNames = [];
                if (currentDJ.firstName && currentDJ.lastName) {
                    possibleNames.push(`${currentDJ.firstName} ${currentDJ.lastName}`);
                }
                if (currentDJ.username) {
                    possibleNames.push(currentDJ.username);
                }
                
                // Filter bookings for this DJ
                const djBookings = allBookings.filter(b => {
                    if (!b.djUser) return false;
                    return possibleNames.some(name => 
                        b.djUser.toLowerCase() === name.toLowerCase()
                    );
                });
                
                // Transform to match expected format
                const transformed = djBookings.map(b => ({
                    id: b.id,
                    djUser: b.djUser,
                    clientName: b.clientName,
                    eventType: b.eventType,
                    date: b.date,
                    time: b.time,
                    location: b.location,
                    contactEmail: b.contactEmail,
                    contactPhone: b.contactPhone,
                    notes: b.notes,
                    totalRevenue: b.totalRevenue,
                    ccPayment: b.ccPayment,
                    payout: b.payout
                }));
                
                bookingsCache = transformed;
                bookingsCacheTime = now;
                return transformed;
            } catch (error) {
                console.error('Error fetching bookings:', error);
                // Fallback to localStorage for backward compatibility
                const fallback = JSON.parse(localStorage.getItem('dj_bookings') || '[]');
                return fallback.filter(b => {
                    if (!b.djUser) return false;
                    const currentUsername = localStorage.getItem('dj_user');
                    return b.djUser.toLowerCase().includes(currentUsername.toLowerCase());
                });
            }
        }

        // Set token expiry on page load (30 minutes from now)
        const tokenExpiry = Date.now() + SESSION_TIMEOUT;
        localStorage.setItem(TOKEN_EXPIRY_KEY, tokenExpiry.toString());
        
        // Initialize activity tracking
        updateActivity();
        
        // Log successful login
        logSecurityEvent('page_access', { page: 'dashboard' });

        // Handle page visibility changes (user switches tabs/windows)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                logSecurityEvent('page_hidden', {});
            } else {
                // Check token validity when page becomes visible again
                if (!validateToken()) {
                    secureLogout('Your session has expired. Please log in again.');
                } else {
                    updateActivity();
                }
            }
        });

        // Warn user if they try to leave with unsaved changes
        let hasUnsavedChanges = false;
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Track form changes
        document.addEventListener('input', function(e) {
            if (e.target.closest('form')) {
                hasUnsavedChanges = true;
            }
        });

        document.addEventListener('submit', function(e) {
            if (e.target.tagName === 'FORM') {
                hasUnsavedChanges = false;
            }
        });

        // ========================================
        // END SECURITY MEASURES
        // ========================================

        // Date formatting helper function - formats date as mm-dd-yyyy
        function formatDateMMDDYYYY(date) {
            if (!date) return '';
            
            let dateObj;
            if (date instanceof Date) {
                dateObj = date;
            } else if (typeof date === 'string') {
                // Handle YYYY-MM-DD format - parse as local date to avoid timezone issues
                if (date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = date.split('-');
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                    const day = parseInt(parts[2], 10);
                    dateObj = new Date(year, month, day); // Creates local date (no timezone shift)
                } else if (date.includes('T')) {
                    // Handle ISO format - extract date part and parse as local
                    const datePart = date.split('T')[0];
                    const parts = datePart.split('-');
                    const year = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1;
                    const day = parseInt(parts[2], 10);
                    dateObj = new Date(year, month, day); // Creates local date
                } else {
                    // Try to parse as-is (fallback)
                    dateObj = new Date(date);
                }
            } else {
                dateObj = new Date(date);
            }
            
            if (isNaN(dateObj.getTime())) return '';
            
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            const year = dateObj.getFullYear();
            
            return `${month}-${day}-${year}`;
        }
        

        // Load user data
        function loadDJUserInfo() {
            const currentUsername = localStorage.getItem('dj_user') || 'DJ User';
            
            // Try to get full user info from localStorage
            const allDJs = JSON.parse(localStorage.getItem('dj_users') || '[]');
            const currentDJ = allDJs.find(dj => dj.username === currentUsername);
            
            let displayName = currentUsername;
            
            if (currentDJ) {
                // Display full name or username
                displayName = currentDJ.fullName || currentDJ.name || currentDJ.username;
                
                // Update header welcome message and name
                const headerWelcome = document.getElementById('header-welcome');
                const headerUserName = document.getElementById('header-user-name');
                if (headerWelcome) headerWelcome.textContent = 'Welcome, ';
                if (headerUserName) headerUserName.textContent = displayName;
                
                // Update dropdown menu
                document.getElementById('dropdown-name').textContent = displayName;
                
                // Update profile icon with initials
                updateProfileIcon(displayName);
                
                // Update calendar welcome message
                const welcomeMsg = document.getElementById('dj-welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Welcome back, ${displayName}!`;
                }
            } else {
                // Update header with username
                const headerWelcome = document.getElementById('header-welcome');
                const headerUserName = document.getElementById('header-user-name');
                if (headerWelcome) headerWelcome.textContent = 'Welcome, ';
                if (headerUserName) headerUserName.textContent = currentUsername;
                
                // Update dropdown menu
                document.getElementById('dropdown-name').textContent = currentUsername;
                
                // Update profile icon with initials
                updateProfileIcon(currentUsername);
                
                // Update calendar welcome message
                const welcomeMsg = document.getElementById('dj-welcome-message');
                if (welcomeMsg) {
                    welcomeMsg.textContent = `Welcome back, ${currentUsername}!`;
                }
            }
            
        }
        
        // Update profile icon with user initials
        function updateProfileIcon(name) {
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            document.getElementById('profile-initials').textContent = initials || 'DJ';
            updateProfileIconWithPicture();
        }
        
        // Update profile icon with picture if available
        function updateProfileIconWithPicture() {
            const currentUsername = localStorage.getItem('dj_user');
            const allDJs = JSON.parse(localStorage.getItem('dj_users') || '[]');
            const currentDJ = allDJs.find(dj => dj.username === currentUsername);
            const profileIcon = document.getElementById('profile-icon');
            const profileInitials = document.getElementById('profile-initials');
            
            if (currentDJ && currentDJ.profilePicture) {
                // Check if img element exists, if not create it
                let img = profileIcon.querySelector('img');
                if (!img) {
                    img = document.createElement('img');
                    profileIcon.insertBefore(img, profileInitials);
                }
                img.src = currentDJ.profilePicture;
                img.style.display = 'block';
                profileInitials.style.display = 'none';
            } else {
                // Show initials, hide image
                const img = profileIcon.querySelector('img');
                if (img) {
                    img.style.display = 'none';
                }
                profileInitials.style.display = 'flex';
            }
        }
        
        // Toggle profile dropdown
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profile-dropdown');
            dropdown.classList.toggle('show');
        }
        
        // Close profile dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const profileMenu = document.querySelector('.user-profile-menu');
            const dropdown = document.getElementById('profile-dropdown');
            
            if (profileMenu && !profileMenu.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
        
        // Toggle account settings in dropdown
        function toggleAccountSettings() {
            const accountForm = document.getElementById('profile-account-form');
            accountForm.classList.toggle('show');
            
            // Load account info when opening
            if (accountForm.classList.contains('show')) {
                loadAccountInfoToDropdown();
                // Show Save and Cancel buttons when opening account settings
                const formActions = document.querySelector('.profile-dropdown-form-actions');
                if (formActions) {
                    formActions.style.display = '';
                }
            }
        }
        
        // Load account information into dropdown form
        function loadAccountInfoToDropdown() {
            const currentUsername = localStorage.getItem('dj_user');
            const allDJs = JSON.parse(localStorage.getItem('dj_users') || '[]');
            const currentDJ = allDJs.find(dj => dj.username === currentUsername);
            
            if (currentDJ) {
                document.getElementById('dropdown-username').value = currentDJ.username || '';
                document.getElementById('dropdown-name').value = currentDJ.fullName || currentDJ.name || '';
                document.getElementById('dropdown-email').value = currentDJ.email || '';
                document.getElementById('dropdown-phone').value = currentDJ.phone || '';
                
                // Load profile picture
                if (currentDJ.profilePicture) {
                    document.getElementById('profile-picture-img').src = currentDJ.profilePicture;
                    document.getElementById('profile-picture-img').style.display = 'block';
                    document.getElementById('profile-picture-initials').style.display = 'none';
                } else {
                    document.getElementById('profile-picture-img').style.display = 'none';
                    document.getElementById('profile-picture-initials').style.display = 'flex';
                    const initials = (currentDJ.fullName || currentDJ.name || currentDJ.username || 'DJ').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                    document.getElementById('profile-picture-initials').textContent = initials;
                }
            } else {
                document.getElementById('dropdown-username').value = currentUsername || '';
                document.getElementById('dropdown-name').value = '';
                document.getElementById('dropdown-email').value = '';
                document.getElementById('dropdown-phone').value = '';
                
                // Default profile picture preview
                document.getElementById('profile-picture-img').style.display = 'none';
                document.getElementById('profile-picture-initials').style.display = 'flex';
                const initials = (currentUsername || 'DJ').split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                document.getElementById('profile-picture-initials').textContent = initials;
            }
        }
        
        // Handle profile picture upload
        function handleProfilePictureUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image size must be less than 5MB.');
                return;
            }
            
            // Read file as data URL
            const reader = new FileReader();
            reader.onload = function(e) {
                const imageData = e.target.result;
                
                // Update preview
                document.getElementById('profile-picture-img').src = imageData;
                document.getElementById('profile-picture-img').style.display = 'block';
                document.getElementById('profile-picture-initials').style.display = 'none';
                
                // Store in a temporary variable to save when form is submitted
                window.tempProfilePicture = imageData;
            };
            reader.readAsDataURL(file);
        }
        
        // Save account from dropdown - Enhanced with input validation and sanitization
        function saveAccountFromDropdown(event) {
            if (event) {
                event.preventDefault();
            }
            
            // Validate token before allowing action
            if (!validateToken()) {
                return;
            }
            
            const currentUsername = localStorage.getItem('dj_user');
            const allDJs = JSON.parse(localStorage.getItem('dj_users') || '[]');
            
            // Find user by username, firstName+lastName, or email (more robust matching)
            const currentDJIndex = allDJs.findIndex(dj => {
                // Match by username
                if (dj.username && dj.username.toLowerCase().trim() === currentUsername.toLowerCase().trim()) {
                    return true;
                }
                // Match by firstName + lastName
                if (dj.firstName && dj.lastName) {
                    const fullName = `${dj.firstName} ${dj.lastName}`;
                    if (fullName.toLowerCase().trim() === currentUsername.toLowerCase().trim()) {
                        return true;
                    }
                }
                // Match by email (if username is email)
                if (dj.email && dj.email.toLowerCase().trim() === currentUsername.toLowerCase().trim()) {
                    return true;
                }
                return false;
            });
            
            let username = document.getElementById('dropdown-username').value.trim();
            let email = document.getElementById('dropdown-email').value.trim();
            let phone = document.getElementById('dropdown-phone').value.trim();
            let name = document.getElementById('dropdown-name').value.trim();
            
            // Sanitize all inputs
            username = sanitizeInput(username);
            email = sanitizeInput(email);
            phone = sanitizeInput(phone);
            name = sanitizeInput(name);
            
            // Validate username
            if (!username) {
                alert('Username is required');
                return;
            }
            
            if (username.length < 3) {
                alert('Username must be at least 3 characters long');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!email) {
                alert('Email address is required');
                return;
            }
            
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                logSecurityEvent('invalid_input', { field: 'email', value: email });
                return;
            }
            
            // Validate phone format (optional but check if provided)
            if (phone && !/^[\d\s\-\(\)]+$/.test(phone)) {
                alert('Please enter a valid phone number');
                logSecurityEvent('invalid_input', { field: 'phone', value: phone });
                return;
            }
            
            // Update user info
            if (currentDJIndex !== -1) {
                allDJs[currentDJIndex].username = username;
                allDJs[currentDJIndex].email = email;
                allDJs[currentDJIndex].phone = phone;
                if (name) {
                    allDJs[currentDJIndex].fullName = name;
                    allDJs[currentDJIndex].name = name;
                }
                // Save profile picture if uploaded
                if (window.tempProfilePicture) {
                    allDJs[currentDJIndex].profilePicture = window.tempProfilePicture;
                    window.tempProfilePicture = null;
                }
                
                // Update localStorage dj_user if username changed
                if (username !== currentUsername) {
                    localStorage.setItem('dj_user', username);
                }
            } else {
                const newUser = {
                    username: username,
                    email: email,
                    phone: phone,
                    name: name || '',
                    fullName: name || '',
                    profilePicture: window.tempProfilePicture || null
                };
                allDJs.push(newUser);
                if (window.tempProfilePicture) {
                    window.tempProfilePicture = null;
                }
                // Update localStorage dj_user with new username
                localStorage.setItem('dj_user', username);
            }
            
            // Save updated users list
            localStorage.setItem('dj_users', JSON.stringify(allDJs));
            
            logSecurityEvent('account_update', { fields: ['username', 'email', 'phone', 'name'] });
            
            // Show success message
            const successMsg = document.getElementById('dropdown-save-success');
            successMsg.classList.add('show');
            
            // Hide Save and Cancel buttons after successful save
            const formActions = document.querySelector('.profile-dropdown-form-actions');
            if (formActions) {
                formActions.style.display = 'none';
            }
            
            // Hide success message after 3 seconds
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);
            
            // Reload user info to update header and dropdown
            loadDJUserInfo();
            
            // Update profile icon with picture if available
            updateProfileIconWithPicture();
        }
        
        // Cancel account edit from dropdown
        function cancelAccountFromDropdown() {
            loadAccountInfoToDropdown();
            document.getElementById('dropdown-save-success').classList.remove('show');
            document.getElementById('profile-account-form').classList.remove('show');
        }
        
        
        // Load user info on page load
        loadDJUserInfo();

        // Display blocked dates
        async function displayBlockedDates() {
            const container = document.getElementById('blocked-dates-container');
            
            try {
                const currentUsername = localStorage.getItem('dj_user');
                // Get current DJ user info to match by full name
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                const djFullName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                    ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                    : currentUsername;
                
                // Fetch all blocked dates and filter by DJ name
                const allBlockedDates = await apiGetBlockedDates();
                const blockedDates = allBlockedDates.filter(bd => 
                    bd.djUser === djFullName || bd.djUser === currentUsername
                );

                if (blockedDates.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No dates blocked</p></div>';
                    return;
                }

                container.innerHTML = blockedDates.map(item => {
                    // Normalize date to YYYY-MM-DD format
                    let dateStr = item.date;
                    if (dateStr && typeof dateStr === 'string') {
                        if (dateStr.includes('T')) {
                            dateStr = dateStr.split('T')[0];
                        }
                    }
                    
                    // Parse date string to avoid timezone issues
                    const dateParts = dateStr.split('-');
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1;
                    const day = parseInt(dateParts[2], 10);
                    const dateObj = new Date(year, month, day);
                    const formattedDate = formatDateMMDDYYYY(dateObj);
                    // Sanitize date and reason to prevent XSS
                    const safeDate = escapeHtml(dateStr);
                    const safeFormattedDate = escapeHtml(formattedDate);
                    const safeReason = item.reason ? escapeHtml(item.reason) : '';
                    return `
                        <div class="blocked-date-item">
                            <div class="blocked-date-info">
                                <span class="date-badge">${safeFormattedDate}</span>
                                ${safeReason ? `<div style="color: var(--text-light); font-size: 0.9rem;">${safeReason}</div>` : ''}
                            </div>
                            <div class="blocked-date-actions">
                                <button class="btn btn-secondary" onclick="editBlockedDate('${safeDate}')">Edit</button>
                                <button class="btn btn-danger" onclick="openDeleteBlockedDateConfirmModal('${safeDate}')">Remove</button>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error displaying blocked dates:', error);
                container.innerHTML = '<div class="empty-state"><p>Error loading blocked dates</p></div>';
            }
        }

        // Open edit blocked date modal
        async function openEditBlockedDateModal(date) {
            try {
                // Get current DJ user info to find blocked date
                const currentUsername = localStorage.getItem('dj_user');
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                const djFullName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                    ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                    : currentUsername;
                
                // Fetch all blocked dates to find the one to edit
                const allBlockedDates = await apiGetBlockedDates();
                const blockedDate = allBlockedDates.find(bd => {
                    // Normalize date for comparison
                    let bdDate = bd.date;
                    if (bdDate && typeof bdDate === 'string' && bdDate.includes('T')) {
                        bdDate = bdDate.split('T')[0];
                    }
                    return (bd.djUser === djFullName || bd.djUser === currentUsername) && bdDate === date;
                });
                
                if (!blockedDate) {
                    alert('Blocked date not found.');
                    return;
                }

                // Parse and format date for display
                let dateStr = blockedDate.date;
                if (dateStr && typeof dateStr === 'string' && dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                const dateParts = dateStr.split('-');
                const year = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const day = parseInt(dateParts[2], 10);
                const dateObj = new Date(year, month, day);
                const formattedDate = formatDateMMDDYYYY(dateObj);

                const modal = document.getElementById('blocked-date-modal');
                const title = document.getElementById('blocked-date-modal-title');
                const content = document.getElementById('blocked-date-modal-content');

                title.textContent = 'Edit Blocked Date';
                content.innerHTML = `
                    <div style="margin-bottom: 1.5rem;">
                        <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem;">Date: ${escapeHtml(formattedDate)}</div>
                        <label for="edit-reason" style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">Reason:</label>
                        <textarea id="edit-reason" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem; font-family: inherit; resize: vertical;" placeholder="Enter reason (optional)">${escapeHtml(blockedDate.reason || '')}</textarea>
                        <input type="hidden" id="edit-blocked-date-id" value="${blockedDate.id}">
                        <input type="hidden" id="edit-blocked-date-dj-user" value="${escapeHtml(blockedDate.djUser || djFullName)}">
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeBlockedDateModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                        <button onclick="saveEditedBlockedDate('${escapeHtml(dateStr)}')" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">Save Changes</button>
                    </div>
                `;

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening edit blocked date modal:', error);
                alert('Error loading blocked date information.');
            }
        }

        // Open delete blocked date modal
        function openDeleteBlockedDateModal(date) {
            const blockedDates = JSON.parse(localStorage.getItem('blocked_dates') || '[]');
            const blockedDate = blockedDates.find(item => item.date === date);
            
            if (!blockedDate) return;

            // Parse and format date for display
            const dateParts = blockedDate.date.split('-');
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[2], 10);
            const dateObj = new Date(year, month, day);
            const formattedDate = formatDateMMDDYYYY(dateObj);

            const modal = document.getElementById('blocked-date-modal');
            const title = document.getElementById('blocked-date-modal-title');
            const content = document.getElementById('blocked-date-modal-content');

            title.textContent = 'Delete Blocked Date';
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: var(--text-dark); margin-bottom: 0.5rem;">Are you sure you want to delete this blocked date?</p>
                    <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 0.5rem;">Date: ${escapeHtml(formattedDate)}</div>
                    ${blockedDate.reason ? `<div style="color: var(--text-light); font-size: 0.9rem;">Reason: ${escapeHtml(blockedDate.reason)}</div>` : ''}
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeBlockedDateModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                    <button onclick="closeBlockedDateModal(); openDeleteBlockedDateConfirmModal('${escapeHtml(blockedDate.date)}')" class="btn btn-danger" style="padding: 0.75rem 1.5rem;">Delete</button>
                </div>
            `;

            modal.style.display = 'flex';
        }

        // Close blocked date modal
        function closeBlockedDateModal() {
            const modal = document.getElementById('blocked-date-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Save edited blocked date
        async function saveEditedBlockedDate(date) {
            // Validate token before allowing action
            if (!validateToken()) {
                return;
            }

            const reasonInput = document.getElementById('edit-reason');
            const newReason = reasonInput ? reasonInput.value.trim() : '';
            const blockedDateId = document.getElementById('edit-blocked-date-id')?.value;
            const djUser = document.getElementById('edit-blocked-date-dj-user')?.value;

            // Sanitize reason
            const sanitizedReason = newReason.replace(/[<>]/g, '') || null;

            try {
                if (!blockedDateId) {
                    alert('Blocked date ID not found.');
                    closeBlockedDateModal();
                    return;
                }

                // Delete the old blocked date and create a new one with updated reason
                // (Since there's no PUT endpoint, we delete and recreate)
                await apiDeleteBlockedDate(blockedDateId);
                
                // Recreate with updated reason
                await apiCreateBlockedDate({
                    djUser: djUser,
                    date: date,
                    reason: sanitizedReason,
                    blockedBy: localStorage.getItem('dj_user') || djUser
                });
                
                logSecurityEvent('edit_blocked_date', { date: date, reason: sanitizedReason });

                // Close modal and refresh
                closeBlockedDateModal();
                
                // Refresh entire page to show updated blocked dates
                window.location.reload();
            } catch (error) {
                console.error('Error saving edited blocked date:', error);
                let errorMessage = error.message || 'Unknown error';
                
                // Provide more user-friendly error messages
                if (errorMessage.includes('PAM authentication') || errorMessage.includes('authentication failed')) {
                    errorMessage = 'Database connection error. Please contact the administrator or try again later.';
                }
                
                alert(`Failed to update blocked date: ${errorMessage}. Please try again.`);
            }
        }

        // Confirm and delete blocked date (redirects to confirmation modal)
        function confirmDeleteBlockedDate(date) {
            closeBlockedDateModal();
            openDeleteBlockedDateConfirmModal(date);
        }

        // Open delete blocked date confirmation modal
        async function openDeleteBlockedDateConfirmModal(date) {
            try {
                // Get current DJ user info to find blocked date
                const currentUsername = localStorage.getItem('dj_user');
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                const djFullName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                    ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                    : currentUsername;
                
                // Fetch all blocked dates to find the one to delete
                const allBlockedDates = await apiGetBlockedDates();
                const blockedDate = allBlockedDates.find(bd => {
                    // Normalize date for comparison
                    let bdDate = bd.date;
                    if (bdDate && typeof bdDate === 'string' && bdDate.includes('T')) {
                        bdDate = bdDate.split('T')[0];
                    }
                    return (bd.djUser === djFullName || bd.djUser === currentUsername) && bdDate === date;
                });
                
                if (!blockedDate) {
                    showBlockDateMessage('Blocked date not found.', 'error');
                    return;
                }
                
                // Format date for display
                let dateStr = blockedDate.date;
                if (dateStr && typeof dateStr === 'string' && dateStr.includes('T')) {
                    dateStr = dateStr.split('T')[0];
                }
                const dateParts = dateStr.split('-');
                const year = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const day = parseInt(dateParts[2], 10);
                const dateObj = new Date(year, month, day);
                const formattedDate = formatDateMMDDYYYY(dateObj);
                
                const modal = document.getElementById('block-date-confirm-modal');
                const content = document.getElementById('block-date-confirm-content');
                
                content.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="margin-bottom: 1rem; display: flex; justify-content: center; align-items: center;">
                            <img src="EYP Logo_New.png" alt="EYP Logo" style="max-width: 180px; max-height: 96px; width: auto; height: auto;">
                        </div>
                        <div style="font-size: 1.1rem; color: var(--text-dark); margin-bottom: 0.5rem; font-weight: 500;">
                            Are you sure you want to remove this blocked date?
                        </div>
                        <div style="font-weight: 600; color: var(--primary-color); font-size: 1.2rem; margin-bottom: 1rem;">
                            ${escapeHtml(formattedDate)}
                        </div>
                        ${blockedDate.reason ? `<div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">Reason: ${escapeHtml(blockedDate.reason)}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-direction: row;">
                        <button onclick="confirmUnblockDate('${escapeHtml(date)}')" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1rem;">Remove</button>
                        <button onclick="closeBlockDateConfirmModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Cancel</button>
                    </div>
                `;
                
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error opening delete blocked date modal:', error);
                showBlockDateMessage('Error loading blocked date information.', 'error');
            }
        }

        // Confirm and remove blocked date
        function confirmUnblockDate(date) {
            unblockDate(date);
        }

        // Remove blocked date - Enhanced with security
        async function unblockDate(date) {
            // Validate token before allowing action
            if (!validateToken()) {
                return;
            }
            
            // Validate input
            if (!date || typeof date !== 'string') {
                logSecurityEvent('invalid_input', { field: 'unblock_date', value: date });
                return;
            }

            try {
                // Get current DJ user info to find blocked date
                const currentUsername = localStorage.getItem('dj_user');
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                const djFullName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                    ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                    : currentUsername;
                
                // Fetch all blocked dates to find the one to delete
                const allBlockedDates = await apiGetBlockedDates();
                const blockedDateToDelete = allBlockedDates.find(bd => {
                    // Normalize date for comparison
                    let bdDate = bd.date;
                    if (bdDate && typeof bdDate === 'string' && bdDate.includes('T')) {
                        bdDate = bdDate.split('T')[0];
                    }
                    return (bd.djUser === djFullName || bd.djUser === currentUsername) && bdDate === date;
                });
                
                if (!blockedDateToDelete || !blockedDateToDelete.id) {
                    alert('Blocked date not found.');
                    return;
                }
                
                // Delete via API
                await apiDeleteBlockedDate(blockedDateToDelete.id);
                
                logSecurityEvent('unblock_date', { date: date });
                
                // Close modal first
                closeBlockDateConfirmModal();
                
                // Refresh entire page
                window.location.reload();
            } catch (error) {
                console.error('Error unblocking date:', error);
                let errorMessage = error.message || 'Unknown error';
                
                // Provide more user-friendly error messages
                if (errorMessage.includes('PAM authentication') || errorMessage.includes('authentication failed')) {
                    errorMessage = 'Database connection error. Please contact the administrator or try again later.';
                }
                
                alert(`Failed to unblock date: ${errorMessage}. Please try again.`);
            }
        }

        // Calendar state
        let currentCalendarDate = new Date();
        currentCalendarDate.setDate(1); // Start at first day of month

        // Generate single calendar widget
        async function generateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            // Update header
            const monthNames = ["January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"];
            const headerElement = document.getElementById('calendar-month-year');
            if (headerElement) {
                headerElement.textContent = `${monthNames[month]} ${year}`;
            }
            
            // Get blocked dates - fetch all and filter by current DJ's name
            const currentUsername = localStorage.getItem('dj_user');
            let blockedDates = [];
            try {
                // Get current DJ user info to match by full name
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                const djFullName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                    ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                    : currentUsername;
                
                // Fetch all blocked dates and filter by DJ name
                const allBlockedDates = await apiGetBlockedDates();
                const djBlockedDates = allBlockedDates.filter(bd => 
                    bd.djUser === djFullName || bd.djUser === currentUsername
                );
                
                // Normalize dates to YYYY-MM-DD format for comparison
                blockedDates = djBlockedDates.map(bd => {
                    let dateStr = bd.date;
                    if (dateStr && typeof dateStr === 'string') {
                        // If it's an ISO string, extract just the date part
                        if (dateStr.includes('T')) {
                            return dateStr.split('T')[0];
                        }
                    }
                    return dateStr;
                }).filter(d => d);
            } catch (error) {
                console.error('Error fetching blocked dates:', error);
                blockedDates = [];
            }
            
            // Get bookings for current DJ
            const djBookings = await getAllBookingsForDJ();
            
            // Helper function to normalize date to YYYY-MM-DD format
            function normalizeDateForCalendar(dateValue) {
                if (!dateValue) return null;
                if (typeof dateValue === 'string') {
                    // If it's an ISO string, extract just the date part
                    if (dateValue.includes('T')) {
                        return dateValue.split('T')[0];
                    }
                    // If it's already YYYY-MM-DD, return as is
                    if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        return dateValue;
                    }
                }
                // If it's a Date object, convert to YYYY-MM-DD
                if (dateValue instanceof Date) {
                    const year = dateValue.getFullYear();
                    const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                    const day = String(dateValue.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                }
                return dateValue;
            }
            
            // Create a map of date to bookings for quick lookup (normalized dates)
            const bookingsByDate = {};
            djBookings.forEach(booking => {
                if (booking.date) {
                    const normalizedDate = normalizeDateForCalendar(booking.date);
                    if (normalizedDate) {
                        if (!bookingsByDate[normalizedDate]) {
                            bookingsByDate[normalizedDate] = [];
                        }
                        bookingsByDate[normalizedDate].push(booking);
                    }
                }
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get previous month days
            const prevMonthDays = new Date(year, month, 0).getDate();
            
            let calendarHTML = '<div class="calendar-grid">';
            
            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                calendarHTML += `<div class="calendar-day-header">${day}</div>`;
            });

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                calendarHTML += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dateObj = new Date(year, month, day);
                dateObj.setHours(0, 0, 0, 0);
                
                let classes = 'calendar-day';
                if (dateObj.getTime() === today.getTime()) {
                    classes += ' today';
                }
                
                const hasBooking = bookingsByDate[dateStr] && bookingsByDate[dateStr].length > 0;
                const isBlocked = blockedDates.includes(dateStr);
                
                if (isBlocked) {
                    classes += ' blocked';
                } else if (hasBooking) {
                    classes += ' has-booking';
                }

                // Determine onclick behavior: show booking details if has booking, otherwise select for blocking
                const onclickAction = hasBooking ? `showBookingDetails('${dateStr}')` : `selectCalendarDate('${dateStr}')`;

                calendarHTML += `
                    <div class="${classes}" onclick="${onclickAction}">
                        <span class="calendar-day-number">${day}</span>
                        ${hasBooking ? '<span class="calendar-day-indicator" style="background: var(--success-color); width: 8px; height: 8px; border-radius: 50%; margin-top: 2px; display: block;"></span>' : ''}
                        ${isBlocked ? '<span class="calendar-day-indicator" style="background: var(--secondary-color); width: 8px; height: 8px; border-radius: 50%; margin-top: 2px; display: block;"></span>' : ''}
                    </div>
                `;
            }

            // Next month days to fill the grid
            const totalCells = firstDay + daysInMonth;
            const remainingCells = 42 - totalCells; // 6 rows * 7 days
            for (let day = 1; day <= remainingCells && day <= 14; day++) {
                calendarHTML += `<div class="calendar-day other-month"><span class="calendar-day-number">${day}</span></div>`;
            }

            calendarHTML += '</div>';
            const container = document.getElementById('calendar-grid-container');
            if (container) {
                container.innerHTML = calendarHTML;
            }
        }

        // Navigate calendar months
        async function previousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            await generateCalendar();
        }

        async function nextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
            await generateCalendar();
        }

        // Show booking details modal
        async function showBookingDetails(dateStr) {
            // Get bookings for this date
            const allBookings = await getAllBookingsForDJ();
            const bookingsForDate = allBookings.filter(b => {
                if (!b.date || b.date !== dateStr) return false;
                return true; // Already filtered in getAllBookingsForDJ
            });
            
            if (bookingsForDate.length === 0) return;
            
            const modal = document.getElementById('booking-details-modal');
            const content = document.getElementById('booking-details-content');
            
            // Format date for display
            const dateParts = dateStr.split('-');
            const formattedDate = `${dateParts[1]}-${dateParts[2]}-${dateParts[0]}`;
            
            content.innerHTML = bookingsForDate.map(booking => {
                const safeClientName = escapeHtml(booking.clientName || '');
                const safeEventType = escapeHtml(booking.eventType || '');
                const safeTime = escapeHtml(booking.time || '');
                const safeLocation = escapeHtml(booking.location || '');
                const safeEmail = escapeHtml(booking.contactEmail || '');
                const safePhone = escapeHtml(booking.contactPhone || '');
                const safeNotes = booking.notes ? escapeHtml(booking.notes) : '';
                const payout = booking.payout ? String(booking.payout).replace(/\$/g, '') : '';
                
                return `
                    <div style="margin-bottom: 1.5rem; padding-bottom: 1.5rem; border-bottom: 1px solid #e0e0e0;">
                        <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">${safeClientName}</h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;"><strong>Date:</strong> ${escapeHtml(formattedDate)}</p>
                        <div style="display: grid; gap: 0.75rem;">
                            <div><strong>Event Type:</strong> ${safeEventType}</div>
                            ${safeTime ? `<div><strong>Time:</strong> ${safeTime}</div>` : ''}
                            ${safeLocation ? `<div><strong>Location:</strong> ${safeLocation}</div>` : ''}
                            ${payout ? `<div><strong>Payout:</strong> <span style="color: var(--success-color); font-weight: bold;">$${payout}</span></div>` : ''}
                            ${safeEmail ? `<div><strong>Email:</strong> ${safeEmail}</div>` : ''}
                            ${safePhone ? `<div><strong>Phone:</strong> ${safePhone}</div>` : ''}
                            ${safeNotes ? `<div style="margin-top: 0.5rem;"><strong>Notes:</strong> ${safeNotes}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            modal.style.display = 'flex';
        }

        // Close booking details modal
        function closeBookingDetails() {
            const modal = document.getElementById('booking-details-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Close modals when clicking outside
        document.addEventListener('click', function(event) {
            const bookingModal = document.getElementById('booking-details-modal');
            const blockedDateModal = document.getElementById('blocked-date-modal');
            const bookingModalPage = document.getElementById('booking-details-modal-page');
            const blockedDateModalPage = document.getElementById('blocked-date-modal-page');
            
            if (bookingModal && event.target === bookingModal) {
                closeBookingDetails();
            }
            
            if (blockedDateModal && event.target === blockedDateModal) {
                closeBlockedDateModal();
            }
            
            if (bookingModalPage && event.target === bookingModalPage) {
                closeBookingDetailsPage();
            }
            
            if (blockedDateModalPage && event.target === blockedDateModalPage) {
                closeBlockedDateModalPage();
            }
        });

        // Select date from calendar widget and block it
        function selectCalendarDate(dateStr) {
            // Validate token before allowing action
            if (!validateToken()) {
                return;
            }
            
            // Check if date is already blocked
            const blockedDates = JSON.parse(localStorage.getItem('blocked_dates') || '[]');
            const isAlreadyBlocked = blockedDates.some(bd => bd.date === dateStr);
            
            if (isAlreadyBlocked) {
                showBlockDateMessage('This date is already blocked.', 'error');
                return;
            }
            
            // Check if date is in the past
            const dateParts = dateStr.split('-');
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[2], 10);
            const selectedDate = new Date(year, month, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            selectedDate.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                showBlockDateMessage('Cannot block dates in the past.', 'error');
                return;
            }
            
            // Show confirmation modal
            openBlockDateConfirmModal(dateStr);
        }

        // Open block date confirmation modal
        function openBlockDateConfirmModal(dateStr) {
            // Format date for display
            const dateParts = dateStr.split('-');
            const year = parseInt(dateParts[0], 10);
            const month = parseInt(dateParts[1], 10) - 1;
            const day = parseInt(dateParts[2], 10);
            const dateObj = new Date(year, month, day);
            const formattedDate = formatDateMMDDYYYY(dateObj);
            
            const modal = document.getElementById('block-date-confirm-modal');
            const content = document.getElementById('block-date-confirm-content');
            
            content.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="font-size: 1.1rem; color: var(--text-dark); margin-bottom: 0.5rem;">
                        Are you sure you want to block this date?
                    </div>
                    <div style="font-weight: 600; color: var(--primary-color); font-size: 1.2rem; margin-bottom: 1rem;">
                        ${escapeHtml(formattedDate)}
                    </div>
                    <label for="block-reason" style="display: block; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">Reason (optional):</label>
                    <textarea id="block-reason" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1rem; font-family: inherit; resize: vertical;" placeholder="Enter reason for blocking this date"></textarea>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeBlockDateConfirmModal()" class="btn btn-secondary" style="padding: 0.75rem 1.5rem;">Cancel</button>
                    <button onclick="confirmBlockDate('${escapeHtml(dateStr)}')" class="btn btn-primary" style="padding: 0.75rem 1.5rem; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">Block Date</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            // Focus on textarea
            setTimeout(() => {
                const textarea = document.getElementById('block-reason');
                if (textarea) textarea.focus();
            }, 100);
        }

        // Close block date confirmation modal
        function closeBlockDateConfirmModal() {
            const modal = document.getElementById('block-date-confirm-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        // Confirm and block the date
        async function confirmBlockDate(dateStr) {
            const reasonTextarea = document.getElementById('block-reason');
            const reason = reasonTextarea ? reasonTextarea.value.trim() : '';
            
            // Sanitize reason input
            const sanitizedReason = reason ? reason.replace(/[<>]/g, '') : 'No reason provided';
            
            try {
                // Get DJ user info from API to get full name
                const currentUsername = localStorage.getItem('dj_user');
                if (!currentUsername) {
                    alert('Error: Please log in again.');
                    return;
                }
                
                // Get current DJ user info from API
                const djUsers = await apiGetUsers('dj');
                const currentDJ = djUsers.find(u => 
                    u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                    (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
                );
                
                const djName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                    ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                    : (currentUsername || 'DJ User');
                
                // Create blocked date via API
                await apiCreateBlockedDate({
                    djUser: djName,
                    date: dateStr,
                    reason: sanitizedReason || null,
                    blockedBy: currentUsername || djName
                });
                
                logSecurityEvent('block_date', { date: dateStr, reason: sanitizedReason });
                
                // Close modal first
                closeBlockDateConfirmModal();
                
                // Refresh entire page to show the new blocked date
                window.location.reload();
            } catch (error) {
                console.error('Error blocking date:', error);
                let errorMessage = error.message || 'Unknown error';
                
                // Provide more user-friendly error messages
                if (errorMessage.includes('PAM authentication') || errorMessage.includes('authentication failed')) {
                    errorMessage = 'Database connection error. Please contact the administrator or try again later.';
                }
                
                alert(`Failed to block date: ${errorMessage}. Please try again.`);
            }
        }

        // Show block date message (success or error)
        function showBlockDateMessage(message, type) {
            const modal = document.getElementById('block-date-confirm-modal');
            const content = document.getElementById('block-date-confirm-content');
            
            const isError = type === 'error';
            const bgColor = isError ? '#fee' : '#efe';
            const borderColor = isError ? '#dc3545' : '#28a745';
            const textColor = isError ? '#721c24' : '#155724';
            const icon = isError ? '‚ùå' : '‚úÖ';
            
            content.innerHTML = `
                <div style="text-align: center; padding: 2rem 1rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">${icon}</div>
                    <div style="font-size: 1.1rem; color: ${textColor}; font-weight: 500;">
                        ${escapeHtml(message)}
                    </div>
                </div>
                <div style="display: flex; justify-content: center;">
                    <button onclick="closeBlockDateConfirmModal()" class="btn btn-primary" style="padding: 0.75rem 2rem; background: var(--accent-color);">OK</button>
                </div>
            `;
            
            modal.style.display = 'flex';
            
            // Auto-close success messages after 2 seconds
            if (!isError) {
                setTimeout(() => {
                    closeBlockDateConfirmModal();
                }, 2000);
            }
        }

        // Load bookings
        async function loadBookings(filter = null) {
            const bookings = await getAllBookingsForDJ();
            
            // If no bookings, don't create sample data (data comes from database)
            if (bookings.length === 0) {
                const sampleBookings = [];
                localStorage.setItem('dj_bookings', JSON.stringify(sampleBookings));
                displayBookings(sampleBookings, filter || 'all');
            } else {
                displayBookings(bookings, filter || 'all');
            }
        }

        // Display bookings
        function displayBookings(bookings, filter = 'all') {
            const container = document.getElementById('bookings-container');
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Filter bookings by current DJ - match by username or full name
            const currentUsername = localStorage.getItem('dj_user');
            
            // Get DJ user info to check for firstName/lastName
            const allDJs = JSON.parse(localStorage.getItem('dj_users') || '[]');
            const currentDJ = allDJs.find(dj => dj.username === currentUsername);
            
            // Build possible matching names (case-insensitive matching)
            const possibleNames = [currentUsername];
            if (currentDJ) {
                if (currentDJ.firstName && currentDJ.lastName) {
                    possibleNames.push(`${currentDJ.firstName} ${currentDJ.lastName}`);
                }
                if (currentDJ.username && currentDJ.username !== currentUsername) {
                    possibleNames.push(currentDJ.username);
                }
            }
            
            // Filter bookings - match if djUser matches any of the possible names (case-insensitive)
            let filteredBookings = bookings.filter(b => {
                if (!b.djUser) return false; // Don't show unassigned bookings
                const bookingDJ = b.djUser.trim();
                return possibleNames.some(name => 
                    name.toLowerCase().trim() === bookingDJ.toLowerCase()
                );
            });
            
            // Helper function to parse date as local date
            function parseLocalDate(dateValue) {
                if (!dateValue) return null;
                if (typeof dateValue === 'string') {
                    // Handle YYYY-MM-DD format - parse as local date
                    if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const parts = dateValue.split('-');
                        return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
                    }
                    // Handle ISO format - extract date part and parse as local
                    if (dateValue.includes('T')) {
                        const datePart = dateValue.split('T')[0];
                        const parts = datePart.split('-');
                        return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
                    }
                }
                return new Date(dateValue);
            }
            
            if (filter === 'upcoming') {
                filteredBookings = filteredBookings.filter(b => {
                    const bookingDate = parseLocalDate(b.date);
                    if (!bookingDate) return false;
                    bookingDate.setHours(0, 0, 0, 0);
                    return bookingDate >= today;
                });
            } else if (filter === 'past') {
                filteredBookings = filteredBookings.filter(b => {
                    const bookingDate = parseLocalDate(b.date);
                    if (!bookingDate) return false;
                    bookingDate.setHours(0, 0, 0, 0);
                    return bookingDate < today;
                });
            }

            // Helper function to parse booking date consistently (always as local date)
            function parseBookingDate(dateValue) {
                if (!dateValue) return null;
                if (dateValue instanceof Date) return dateValue;
                if (typeof dateValue === 'string') {
                    // Handle YYYY-MM-DD format - parse as local date to avoid timezone issues
                    if (dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const parts = dateValue.split('-');
                        const year = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                        const day = parseInt(parts[2], 10);
                        return new Date(year, month, day); // Creates local date (no timezone shift)
                    }
                    // Handle ISO format (e.g., "2025-04-10T00:00:00.000Z") - extract date part and parse as local
                    if (dateValue.includes('T')) {
                        const datePart = dateValue.split('T')[0];
                        const parts = datePart.split('-');
                        const year = parseInt(parts[0], 10);
                        const month = parseInt(parts[1], 10) - 1;
                        const day = parseInt(parts[2], 10);
                        return new Date(year, month, day); // Creates local date
                    }
                }
                // Fallback: try to create Date object (may still have timezone issues, but better than nothing)
                const date = new Date(dateValue);
                return isNaN(date.getTime()) ? null : date;
            }
            
            // Sort bookings by date (earliest first)
            filteredBookings.sort((a, b) => {
                const dateA = parseBookingDate(a.date);
                const dateB = parseBookingDate(b.date);
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1; // Put dates without valid dates at the end
                if (!dateB) return -1;
                return dateA.getTime() - dateB.getTime(); // Ascending order (earliest first)
            });

            if (filteredBookings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÖ</div><p>No projects found</p></div>';
                return;
            }

            container.innerHTML = filteredBookings.map(booking => {
                // Parse date using the helper function
                const bookingDate = parseBookingDate(booking.date);
                if (!bookingDate) {
                    // Skip bookings with invalid dates
                    return '';
                }
                bookingDate.setHours(0, 0, 0, 0);
                const isUpcoming = bookingDate >= today;
                const daysUntil = Math.ceil((bookingDate - today) / (1000 * 60 * 60 * 24));
                const showReminder = isUpcoming && daysUntil <= 14;

                const formattedDate = formatDateMMDDYYYY(bookingDate);

                // Sanitize all booking data to prevent XSS
                const safeClientName = escapeHtml(booking.clientName || '');
                const safeEventType = escapeHtml(booking.eventType || '');
                const safeTime = escapeHtml(booking.time || '');
                const safeLocation = escapeHtml(booking.location || '');
                const safeEmail = escapeHtml(booking.contactEmail || '');
                const safePhone = escapeHtml(booking.contactPhone || '');
                const safeNotes = booking.notes ? escapeHtml(booking.notes) : '';
                
                return `
                    <div class="booking-card ${isUpcoming ? 'upcoming' : 'past'}">
                        <div class="booking-header">
                            <div>
                                <div class="booking-title">${safeClientName}</div>
                                <div class="booking-date">${escapeHtml(formattedDate)}</div>
                            </div>
                            ${showReminder ? '<span class="reminder-badge">Reminder sent</span>' : ''}
                        </div>
                        <div class="booking-details">
                            <div class="booking-detail-item">
                                <span class="booking-detail-label">Event Type</span>
                                <span class="booking-detail-value">${safeEventType}</span>
                            </div>
                            <div class="booking-detail-item">
                                <span class="booking-detail-label">Time</span>
                                <span class="booking-detail-value">${safeTime}</span>
                            </div>
                            <div class="booking-detail-item">
                                <span class="booking-detail-label">Location</span>
                                <span class="booking-detail-value">${safeLocation}</span>
                            </div>
                            ${booking.payout ? `
                            <div class="booking-detail-item">
                                <span class="booking-detail-label">Payout</span>
                                <span class="booking-detail-value" style="color: var(--success-color); font-weight: bold;">$${String(booking.payout).replace(/\$/g, '')}</span>
                            </div>
                            ` : ''}
                            <div class="booking-detail-item">
                                <span class="booking-detail-label">Contact</span>
                                <span class="booking-detail-value">${safeEmail}<br>${safePhone}</span>
                            </div>
                        </div>
                        ${safeNotes ? `<div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;"><strong>Notes:</strong> ${safeNotes}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Check and send reminders for upcoming bookings
            if (filter === 'all' || filter === 'upcoming') {
                checkAndSendReminders(filteredBookings);
            }
        }

        // Filter bookings
        async function filterBookings(filter) {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Find and activate the button with the matching filter
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent.trim().toLowerCase() === filter.toLowerCase() || 
                    (filter === 'all' && btn.textContent.trim() === 'All') ||
                    (filter === 'upcoming' && btn.textContent.trim() === 'Upcoming') ||
                    (filter === 'past' && btn.textContent.trim() === 'Past')) {
                    btn.classList.add('active');
                }
            });

            // Reload bookings from API
            await loadBookings(filter);
        }

        // Check and send reminders (2 weeks prior)
        function checkAndSendReminders(bookings) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const twoWeeksFromNow = new Date(today);
            twoWeeksFromNow.setDate(twoWeeksFromNow.getDate() + 14);

            bookings.forEach(booking => {
                // Parse date as local date to avoid timezone issues
                let bookingDate;
                if (typeof booking.date === 'string' && booking.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const parts = booking.date.split('-');
                    bookingDate = new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
                } else {
                    bookingDate = new Date(booking.date);
                }
                bookingDate.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((bookingDate - today) / (1000 * 60 * 60 * 24));

                // If booking is exactly 14 days away and reminder hasn't been sent
                if (daysUntil === 14) {
                    // TODO: Send email via backend API
                    console.log(`Sending reminder email for booking: ${booking.clientName} on ${booking.date}`);
                    // In production, this would call your backend API to send the email
                }
            });
        }

        // Logout - Enhanced with security
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                secureLogout('You have been logged out successfully.');
            }
        }

        // Load reviews for current DJ
        function loadReviews() {
            const currentUsername = localStorage.getItem('dj_user');
            const allReviews = JSON.parse(localStorage.getItem('dj_reviews') || '[]');
            
            // Filter reviews by DJ username (exact match)
            let djReviews = allReviews.filter(review => review.djUsername === currentUsername);
            
            // Also include reviews where the comment mentions the DJ's first name
            // This is a fallback for reviews that may not have been properly synced
            if (currentUsername) {
                const djUsers = JSON.parse(localStorage.getItem('dj_users') || '[]');
                const currentDJ = djUsers.find(dj => dj.username === currentUsername);
                if (currentDJ && currentDJ.firstName) {
                    const firstNamePattern = new RegExp(`\\b${currentDJ.firstName}\\b`, 'i');
                    const additionalReviews = allReviews.filter(review => {
                        // Don't include reviews already matched by username
                        if (review.djUsername === currentUsername) return false;
                        // Check if comment mentions the DJ's first name
                        const commentText = (review.comment || '').toLowerCase();
                        return firstNamePattern.test(commentText);
                    });
                    djReviews = [...djReviews, ...additionalReviews];
                }
            }
            
            displayReviews(djReviews);
            updateReviewStats(djReviews);
        }
        
        // Display reviews
        function displayReviews(reviews) {
            const container = document.getElementById('reviews-container');
            
            if (reviews.length === 0) {
                container.innerHTML = `
                    <div class="no-reviews">
                        <div class="no-reviews-icon">‚≠ê</div>
                        <p>No reviews yet. Your customer reviews will appear here.</p>
                    </div>
                `;
                return;
            }
            
            // Sort reviews by date (newest first) - parse as local dates
            reviews.sort((a, b) => {
                const parseLocalDate = (dateValue) => {
                    if (!dateValue) return new Date(0);
                    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const parts = dateValue.split('-');
                        return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
                    }
                    return new Date(dateValue);
                };
                return parseLocalDate(b.date) - parseLocalDate(a.date);
            });
            
            container.innerHTML = reviews.map(review => {
                // Parse date string to avoid timezone issues
                let reviewDate;
                if (typeof review.date === 'string' && review.date.includes('-')) {
                    const dateParts = review.date.split('-');
                    const year = parseInt(dateParts[0], 10);
                    const month = parseInt(dateParts[1], 10) - 1;
                    const day = parseInt(dateParts[2], 10);
                    reviewDate = new Date(year, month, day);
                } else {
                    reviewDate = new Date(review.date);
                }
                const formattedDate = formatDateMMDDYYYY(reviewDate);
                
                // Generate star rating display
                const fullStars = '‚òÖ'.repeat(Math.floor(review.rating));
                const emptyStars = '‚òÜ'.repeat(5 - Math.floor(review.rating));
                const stars = fullStars + emptyStars;
                
                // Sanitize review data to prevent XSS
                const safeClientName = escapeHtml(review.clientName || 'Anonymous');
                const safeEventName = review.eventName ? escapeHtml(review.eventName) : '';
                const safeComment = review.comment ? escapeHtml(review.comment) : 'No comment provided.';
                
                return `
                    <div class="review-card">
                        <div class="review-header">
                            <div>
                                <div class="review-client">${safeClientName}</div>
                                ${safeEventName ? `<div class="review-event">${safeEventName}</div>` : ''}
                            </div>
                            <div class="review-date">${escapeHtml(formattedDate)}</div>
                        </div>
                        <div class="review-rating">${escapeHtml(stars)}</div>
                        <div class="review-text">${safeComment}</div>
                    </div>
                `;
            }).join('');
        }
        
        // Update review statistics
        function updateReviewStats(reviews) {
            if (reviews.length === 0) {
                document.getElementById('average-rating').textContent = '0.0';
                document.getElementById('rating-stars').textContent = '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ';
                document.getElementById('total-reviews').textContent = '0 Reviews';
                return;
            }
            
            // Calculate average rating
            const totalRating = reviews.reduce((sum, review) => sum + review.rating, 0);
            const averageRating = (totalRating / reviews.length).toFixed(1);
            
            // Update average rating display
            document.getElementById('average-rating').textContent = averageRating;
            
            // Update star display (show average as filled stars)
            const avgStars = Math.round(averageRating);
            const fullStars = '‚òÖ'.repeat(avgStars);
            const emptyStars = '‚òÜ'.repeat(5 - avgStars);
            document.getElementById('rating-stars').textContent = fullStars + emptyStars;
            
            // Update total reviews count
            const reviewCount = reviews.length;
            document.getElementById('total-reviews').textContent = `${reviewCount} ${reviewCount === 1 ? 'Review' : 'Reviews'}`;
        }
        
        // Helper function to add a review (can be called from admin dashboard or API)
        // Example usage: addReview('djusername', { clientName: 'John Doe', rating: 5, comment: 'Great service!', eventName: 'Wedding', date: '2025-01-15' })
        function addReview(djUsername, reviewData) {
            const allReviews = JSON.parse(localStorage.getItem('dj_reviews') || '[]');
            const newReview = {
                id: Date.now().toString(),
                djUsername: djUsername,
                clientName: reviewData.clientName || 'Anonymous',
                rating: reviewData.rating || 5,
                comment: reviewData.comment || '',
                eventName: reviewData.eventName || '',
                date: reviewData.date || new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                source: reviewData.source || 'manual' // Track where review came from
            };
            allReviews.push(newReview);
            localStorage.setItem('dj_reviews', JSON.stringify(allReviews));
            
            // Reload reviews if current user
            const currentUsername = localStorage.getItem('dj_user');
            if (currentUsername === djUsername) {
                loadReviews();
            }
        }

        // Sync testimonials from website to DJ reviews
        // This function scans testimonials and checks for mentions of DJ names
        function syncWebsiteTestimonialsToDJReviews() {
            // DJ name mappings: first name -> full username
            const djNameMap = {
                'will': 'Will Luke',
                'gavin': 'Gavin McDuffie',
                'stephen': 'Stephen Kena'
            };

            // Testimonials data structure - can be populated from website or admin dashboard
            // Format: { text: string, clientName?: string, date?: string, service?: string }
            const websiteTestimonials = JSON.parse(localStorage.getItem('website_testimonials') || '[]');
            
            if (websiteTestimonials.length === 0) {
                console.log('No website testimonials found to sync.');
                return;
            }

            const allReviews = JSON.parse(localStorage.getItem('dj_reviews') || '[]');
            const existingReviewIds = new Set(allReviews.map(r => r.id));
            let syncedCount = 0;

            websiteTestimonials.forEach(testimonial => {
                const testimonialText = (testimonial.text || testimonial.comment || '').toLowerCase();
                
                // Check which DJ names are mentioned in the testimonial
                Object.keys(djNameMap).forEach(firstName => {
                    // Use word boundary to match first name (case-insensitive)
                    const namePattern = new RegExp(`\\b${firstName}\\b`, 'i');
                    if (namePattern.test(testimonialText)) {
                        const djUsername = djNameMap[firstName];
                        
                        // Create a unique ID based on testimonial text hash and DJ username
                        // Use a simple hash function to create consistent IDs
                        let hash = 0;
                        const idString = testimonialText.substring(0, 100) + djUsername;
                        for (let i = 0; i < idString.length; i++) {
                            const char = idString.charCodeAt(i);
                            hash = ((hash << 5) - hash) + char;
                            hash = hash & hash; // Convert to 32bit integer
                        }
                        const reviewId = `web_${Math.abs(hash)}_${djUsername.replace(/\s+/g, '_')}`;
                        
                        // Check if this review already exists (by ID or by matching content + DJ)
                        const reviewExists = allReviews.some(r => 
                            r.id === reviewId || 
                            (r.source === 'website' && 
                             r.djUsername === djUsername && 
                             r.comment.toLowerCase().trim() === testimonialText.trim())
                        );
                        
                        if (reviewExists) {
                            return;
                        }

                        // Extract client name from testimonial or use default
                        const clientName = testimonial.clientName || testimonial.name || 'Website Review';

                        // Extract date - use testimonial date or current date
                        let reviewDate = testimonial.date || testimonial.reviewDate;
                        if (reviewDate && typeof reviewDate === 'string') {
                            // Try to parse date - if it's just a year, use Jan 1st of that year
                            if (/^\d{4}$/.test(reviewDate)) {
                                reviewDate = `${reviewDate}-01-01`;
                            }
                        } else {
                            reviewDate = new Date().toISOString().split('T')[0];
                        }

                        // Extract event/service name
                        const eventName = testimonial.eventName || testimonial.service || testimonial.event || '';

                        // Create review entry
                        const newReview = {
                            id: reviewId,
                            djUsername: djUsername,
                            clientName: clientName,
                            rating: testimonial.rating || 5, // Default to 5 stars if not specified
                            comment: testimonial.text || testimonial.comment || '',
                            eventName: eventName,
                            date: reviewDate,
                            createdAt: new Date().toISOString(),
                            source: 'website'
                        };

                        allReviews.push(newReview);
                        existingReviewIds.add(reviewId);
                        syncedCount++;
                    }
                });
            });

            // Save all reviews
            localStorage.setItem('dj_reviews', JSON.stringify(allReviews));
            
            console.log(`Synced ${syncedCount} testimonials to DJ reviews.`);
            
            // Reload reviews if user is logged in
            const currentUsername = localStorage.getItem('dj_user');
            if (currentUsername && ['Will Luke', 'Gavin McDuffie', 'Stephen Kena'].includes(currentUsername)) {
                loadReviews();
            }

            return syncedCount;
        }

        // Helper function to manually add testimonials from website HTML
        // This can be called to populate website_testimonials from the testimonials section
        function extractTestimonialsFromHTML() {
            // This function can be called from admin dashboard or website pages
            // It extracts testimonials from the DOM and stores them in website_testimonials
            
            const testimonials = [];
            const testimonialCards = document.querySelectorAll('.testimonial-card, .review-card, [class*="testimonial"], [class*="review"]');
            
            testimonialCards.forEach(card => {
                const textElement = card.querySelector('.testimonial-text, .review-text, p');
                const text = textElement ? textElement.textContent.trim() : '';
                
                if (!text) return;
                
                // Extract date
                const dateElement = card.querySelector('.testimonial-date, .review-date, [class*="date"]');
                let date = '';
                if (dateElement) {
                    const dateText = dateElement.textContent.trim();
                    // Try to extract year or full date
                    const yearMatch = dateText.match(/\b(20\d{2})\b/);
                    if (yearMatch) {
                        date = yearMatch[1];
                    }
                }
                
                // Extract service/event
                const serviceElement = card.querySelector('.testimonial-service-label, .service-label, [class*="service"]');
                const service = serviceElement ? serviceElement.textContent.trim() : '';
                
                testimonials.push({
                    text: text,
                    date: date || new Date().getFullYear().toString(),
                    service: service,
                    source: 'html_extraction'
                });
            });
            
            if (testimonials.length > 0) {
                localStorage.setItem('website_testimonials', JSON.stringify(testimonials));
                console.log(`Extracted ${testimonials.length} testimonials from HTML.`);
            }
            
            return testimonials;
        }

        // Sidebar toggle functions for mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('show');
            }
        }

        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            if (sidebar && overlay) {
                sidebar.classList.remove('open');
                overlay.classList.remove('show');
            }
        }

        // Check if we're on mobile
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Section navigation function
        function showSection(sectionName) {
            // Hide all sections
            const sections = ['dashboard', 'projects', 'reviews'];
            sections.forEach(sec => {
                const section = document.getElementById(`${sec}-section`);
                if (section) {
                    section.style.display = 'none';
                    section.classList.remove('active');
                }
                // Update nav links
                const navLink = document.getElementById(`nav-${sec}`);
                if (navLink) {
                    navLink.classList.remove('active');
                }
            });

            // Show selected section
            const selectedSection = document.getElementById(`${sectionName}-section`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                selectedSection.classList.add('active');
            }
            
            // Update nav link
            const selectedNav = document.getElementById(`nav-${sectionName}`);
            if (selectedNav) {
                selectedNav.classList.add('active');
            }

            // Close sidebar on mobile after selection
            if (isMobile()) {
                closeSidebar();
            }

            // Load section-specific content
            if (sectionName === 'dashboard') {
                updateDashboardStats();
                generateCalendar();
                displayBlockedDates(); // Display blocked dates list with edit/delete functionality
            } else if (sectionName === 'projects') {
                // Check if a filter was passed (from URL or function parameter)
                const urlParams = new URLSearchParams(window.location.search);
                const filter = urlParams.get('filter') || null;
                if (typeof loadBookings === 'function') loadBookings(filter);
            } else if (sectionName === 'reviews') {
                // Sync website testimonials before loading reviews
                if (typeof syncWebsiteTestimonialsToDJReviews === 'function') {
                    syncWebsiteTestimonialsToDJReviews();
                }
                if (typeof loadReviews === 'function') loadReviews();
            }
        }

        // Navigate to next booking (projects filtered to upcoming)
        function goToNextBooking() {
            showSection('projects');
            // Small delay to ensure section is loaded, then filter to upcoming
            setTimeout(() => {
                // Set the filter button to active
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.textContent.toLowerCase().includes('upcoming')) {
                        btn.classList.add('active');
                    }
                });
                // Load bookings with upcoming filter
                if (typeof loadBookings === 'function') {
                    loadBookings('upcoming');
                }
            }, 100);
        }

        // Update dashboard statistics
        async function updateDashboardStats() {
            const bookings = await getAllBookingsForDJ();
            const currentUsername = localStorage.getItem('dj_user');
            
            // Get DJ user info to check for firstName/lastName
            const allDJs = JSON.parse(localStorage.getItem('dj_users') || '[]');
            const currentDJ = allDJs.find(dj => dj.username === currentUsername);
            
            // Build possible matching names (case-insensitive matching)
            const possibleNames = [currentUsername];
            if (currentDJ) {
                if (currentDJ.firstName && currentDJ.lastName) {
                    possibleNames.push(`${currentDJ.firstName} ${currentDJ.lastName}`);
                }
                if (currentDJ.username && currentDJ.username !== currentUsername) {
                    possibleNames.push(currentDJ.username);
                }
            }
            
            // Filter bookings for current DJ (case-insensitive match)
            const djBookings = bookings.filter(b => {
                if (!b.djUser) return false;
                const bookingDJ = b.djUser.trim();
                return possibleNames.some(name => 
                    name.toLowerCase().trim() === bookingDJ.toLowerCase()
                );
            });
            
            // Calculate total bookings (only upcoming/future bookings)
            const todayForStats = new Date();
            todayForStats.setHours(0, 0, 0, 0);
            const upcomingBookingsForStats = djBookings.filter(b => {
                if (!b.date) return false;
                const dateParts = b.date.split('-');
                const year = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const day = parseInt(dateParts[2], 10);
                const bookingDate = new Date(year, month, day);
                bookingDate.setHours(0, 0, 0, 0);
                return bookingDate >= todayForStats;
            });
            const totalBookings = upcomingBookingsForStats.length;
            document.getElementById('total-bookings-stat').textContent = totalBookings;
            
            // Calculate total revenue (only DJ payout from upcoming bookings)
            // Only use payout field for upcoming bookings
            let totalRevenue = 0;
            
            // Only calculate revenue from upcoming bookings using payout field
            upcomingBookingsForStats.forEach(booking => {
                // Only use payout field for DJ revenue (not totalRevenue)
                if (booking.payout) {
                    // Remove $ and commas, convert to number
                    const payoutValue = String(booking.payout).replace(/[$,]/g, '').trim();
                    const payoutAmount = parseFloat(payoutValue) || 0;
                    totalRevenue += payoutAmount;
                }
            });
            
            // Format revenue with commas
            const formattedRevenue = totalRevenue.toLocaleString('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
            document.getElementById('total-revenue-stat').textContent = formattedRevenue;
            
            // Find next booking date
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingBookings = djBookings.filter(b => {
                if (!b.date) return false;
                const dateParts = b.date.split('-');
                const year = parseInt(dateParts[0], 10);
                const month = parseInt(dateParts[1], 10) - 1;
                const day = parseInt(dateParts[2], 10);
                const bookingDate = new Date(year, month, day);
                bookingDate.setHours(0, 0, 0, 0);
                return bookingDate >= today;
            }).sort((a, b) => {
                // Sort by date ascending - parse as local dates to avoid timezone issues
                const parseLocalDate = (dateValue) => {
                    if (!dateValue) return new Date(0);
                    if (typeof dateValue === 'string' && dateValue.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const parts = dateValue.split('-');
                        return new Date(parseInt(parts[0], 10), parseInt(parts[1], 10) - 1, parseInt(parts[2], 10));
                    }
                    return new Date(dateValue);
                };
                return parseLocalDate(a.date) - parseLocalDate(b.date);
            });
            
            const nextBookingElement = document.getElementById('next-booking-stat');
            if (upcomingBookings.length > 0) {
                const nextBooking = upcomingBookings[0];
                let formattedDate = 'Invalid date';
                
                try {
                    let dateStr = nextBooking.date;
                    if (!dateStr) {
                        formattedDate = 'Invalid date';
                    } else {
                        // Use the formatDateMMDDYYYY helper which handles Date objects, ISO strings, etc.
                        // It will try to parse any string format
                        formattedDate = formatDateMMDDYYYY(dateStr);
                        
                        // If formatDateMMDDYYYY returns empty, the date couldn't be parsed
                        // Try to manually parse the string
                        if (!formattedDate && typeof dateStr === 'string') {
                            // Handle malformed formats like "04-11T00:00:00.000Z-2026"
                            // Extract year from the end if present
                            const yearMatch = dateStr.match(/-(\d{4})$/);
                            const monthDayMatch = dateStr.match(/^(\d{2})-(\d{2})/);
                            
                            if (yearMatch && monthDayMatch) {
                                const year = parseInt(yearMatch[1], 10);
                                const month = parseInt(monthDayMatch[1], 10) - 1;
                                const day = parseInt(monthDayMatch[2], 10);
                                const dateObj = new Date(year, month, day);
                                formattedDate = formatDateMMDDYYYY(dateObj);
                            } else {
                                // Try one more time with Date constructor
                                const dateObj = new Date(dateStr);
                                if (!isNaN(dateObj.getTime())) {
                                    formattedDate = formatDateMMDDYYYY(dateObj);
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('Error formatting next booking date:', error, nextBooking.date);
                    formattedDate = nextBooking.date ? String(nextBooking.date) : 'Invalid date';
                }
                
                // If we still don't have a formatted date, show a safe fallback
                if (!formattedDate || formattedDate === 'Invalid date') {
                    formattedDate = 'Date unavailable';
                }
                
                nextBookingElement.textContent = formattedDate;
                nextBookingElement.style.fontSize = '1.25rem';
            } else {
                nextBookingElement.textContent = 'No upcoming bookings';
                nextBookingElement.style.fontSize = '1rem';
            }
        }

        // Initialize - Load dashboard by default and initial data
        // Check if this is a refresh after authentication (do this first, before any other code)
        const urlParams = new URLSearchParams(window.location.search);
        const shouldRefresh = urlParams.get('refresh') === 'true';
        
        if (shouldRefresh) {
            // Clear all caches
            bookingsCache = null;
            bookingsCacheTime = null;
            
            // Redirect to clean URL (without refresh parameter) to reload page with fresh data
            window.location.href = window.location.pathname;
            return; // Exit early, page will reload
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => initializeDashboard());
        } else {
            initializeDashboard();
        }

        async function initializeDashboard() {
            showSection('dashboard');
            
            // Optimize: Load all required data in parallel first
            const currentUsername = localStorage.getItem('dj_user');
            if (!currentUsername) {
                console.error('No DJ user found');
                return;
            }
            
            // Fetch data in parallel for faster loading
            const [djUsers, bookings, blockedDates] = await Promise.all([
                apiGetUsers('dj').catch(() => []),
                getAllBookingsForDJ().catch(() => []),
                apiGetBlockedDates().catch(() => [])
            ]);
            
            // Find current DJ user info
            const currentDJ = djUsers.find(u => 
                u.username?.toLowerCase() === currentUsername.toLowerCase() ||
                (u.firstName && u.lastName && `${u.firstName} ${u.lastName}`.toLowerCase() === currentUsername.toLowerCase())
            );
            
            const djFullName = currentDJ && currentDJ.firstName && currentDJ.lastName 
                ? `${currentDJ.firstName} ${currentDJ.lastName}` 
                : currentUsername;
            
            // Filter blocked dates for current DJ
            const djBlockedDates = blockedDates.filter(bd => 
                bd.djUser === djFullName || bd.djUser === currentUsername
            );
            
            // Now update UI with pre-fetched data
            await updateDashboardStats();
            if (typeof generateCalendar === 'function') generateCalendar();
            if (typeof displayBlockedDates === 'function') displayBlockedDates();
            if (typeof loadBookings === 'function') loadBookings();
            
            // Sync website testimonials to DJ reviews on page load (these don't need API calls)
            if (typeof syncWebsiteTestimonialsToDJReviews === 'function') {
                syncWebsiteTestimonialsToDJReviews();
            }
            
            // Also manually add known testimonials if they don't exist yet
            addWillReviewIfNeeded();
            addGavinReviewIfNeeded();
            addStephenReviewIfNeeded();
            
            if (typeof loadReviews === 'function') loadReviews();
        }

        // Manually add Will's review from the website if it doesn't exist
        function addWillReviewIfNeeded() {
            const allReviews = JSON.parse(localStorage.getItem('dj_reviews') || '[]');
            const willReviewText = "Will made our wedding reception absolutely incredible! His energy and enthusiasm were contagious, and he had everyone on the dance floor from the first song to the last. Will took the time to understand our music preferences and created the perfect atmosphere for our celebration. His professional setup and seamless transitions kept the party going all night. We couldn't have asked for a better DJ experience. Thank you, Will!";
            
            // Check if this review already exists
            const reviewExists = allReviews.some(r => 
                r.djUsername === 'Will Luke' && 
                r.comment && 
                r.comment.includes("Will made our wedding reception absolutely incredible")
            );
            
            if (!reviewExists) {
                // Create hash for ID
                let hash = 0;
                const idString = willReviewText.substring(0, 100) + 'Will Luke';
                for (let i = 0; i < idString.length; i++) {
                    const char = idString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                const reviewId = `web_${Math.abs(hash)}_Will_Luke`;
                
                const newReview = {
                    id: reviewId,
                    djUsername: 'Will Luke',
                    clientName: 'Website Review',
                    rating: 5,
                    comment: willReviewText,
                    eventName: 'DJ Entertainment',
                    date: '2025-01-01',
                    createdAt: new Date().toISOString(),
                    source: 'website'
                };
                
                allReviews.push(newReview);
                localStorage.setItem('dj_reviews', JSON.stringify(allReviews));
                console.log('Added Will\'s review to dj_reviews');
            }
        }

        // Manually add Gavin's review from the website if it doesn't exist
        function addGavinReviewIfNeeded() {
            const allReviews = JSON.parse(localStorage.getItem('dj_reviews') || '[]');
            const gavinReviewText = "Gavin was absolutely amazing at our wedding! He kept the dance floor packed all night long with an incredible mix of music that appealed to all our guests. His professionalism and attention to detail were outstanding. Gavin made sure our special day had the perfect soundtrack, and we couldn't have been happier. We highly recommend Gavin for any wedding celebration!";
            
            // Check if this review already exists
            const reviewExists = allReviews.some(r => 
                r.djUsername === 'Gavin McDuffie' && 
                r.comment && 
                r.comment.includes("Gavin was absolutely amazing at our wedding")
            );
            
            if (!reviewExists) {
                // Create hash for ID
                let hash = 0;
                const idString = gavinReviewText.substring(0, 100) + 'Gavin McDuffie';
                for (let i = 0; i < idString.length; i++) {
                    const char = idString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                const reviewId = `web_${Math.abs(hash)}_Gavin_McDuffie`;
                
                const newReview = {
                    id: reviewId,
                    djUsername: 'Gavin McDuffie',
                    clientName: 'Website Review',
                    rating: 5,
                    comment: gavinReviewText,
                    eventName: 'DJ Entertainment',
                    date: '2025-01-01',
                    createdAt: new Date().toISOString(),
                    source: 'website'
                };
                
                allReviews.push(newReview);
                localStorage.setItem('dj_reviews', JSON.stringify(allReviews));
                console.log('Added Gavin\'s review to dj_reviews');
            }
        }

        // Manually add Stephen's review from the website if it doesn't exist
        function addStephenReviewIfNeeded() {
            const allReviews = JSON.parse(localStorage.getItem('dj_reviews') || '[]');
            const stephenReviewText = "Stephen was absolutely phenomenal at our wedding! He created an unforgettable atmosphere that had our guests dancing all night long. Stephen's attention to detail, professionalism, and ability to read the crowd was incredible. He seamlessly mixed the perfect songs that kept everyone on the dance floor. Our wedding reception wouldn't have been the same without Stephen's amazing DJ skills. Highly recommend Stephen for any event!";
            
            // Check if this review already exists
            const reviewExists = allReviews.some(r => 
                r.djUsername === 'Stephen Kena' && 
                r.comment && 
                r.comment.includes("Stephen was absolutely phenomenal at our wedding")
            );
            
            if (!reviewExists) {
                // Create hash for ID
                let hash = 0;
                const idString = stephenReviewText.substring(0, 100) + 'Stephen Kena';
                for (let i = 0; i < idString.length; i++) {
                    const char = idString.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                const reviewId = `web_${Math.abs(hash)}_Stephen_Kena`;
                
                const newReview = {
                    id: reviewId,
                    djUsername: 'Stephen Kena',
                    clientName: 'Website Review',
                    rating: 5,
                    comment: stephenReviewText,
                    eventName: 'DJ Entertainment',
                    date: '2025-01-01',
                    createdAt: new Date().toISOString(),
                    source: 'website'
                };
                
                allReviews.push(newReview);
                localStorage.setItem('dj_reviews', JSON.stringify(allReviews));
                console.log('Added Stephen\'s review to dj_reviews');
            }
        }
    </script>
</body>
</html>

